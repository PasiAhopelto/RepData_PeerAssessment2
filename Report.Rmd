---
title: "Basic Statistical Analysis of Severe Weather Events in the United States"
output: 
  html_document:
    keep_md: true
---

# TODO

Finalize.

Change plots' labels.

## Synopsis

This study uses NOAA Storm Database's data to find out what types events are most harmful to population's health and the types that cause most economical damage across the United States. The study is an assignment from Reproducible Research course by Roger D. Peng, Jeff Leek and Brian Caffo (Johns Hopkins University / Coursera).

## Data Processing

Data was downloaded from https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2 at 2015-03-12 and uncompressed with bzip2.

Analysis is carried out with R's libraries.

```{r}
library(data.table)
library(ggplot2)
library(reshape2)
library(plyr)
library(grid)
```

To answer the first question about effect on populations health, the data is aggregated by event types by calculating sum and mean of fatalities and injuries.
```{r cache=TRUE}
csv <- read.csv(file = 'repdata_data_StormData.csv')
fatalitiesAndInjuriesSumByEventType <- aggregate(. ~ EVTYPE, data=csv[,c('EVTYPE', 'FATALITIES', 'INJURIES')], FUN=sum)
fatalitiesAndInjuriesMeanByEventType <- aggregate(. ~ EVTYPE, data=csv[,c('EVTYPE', 'FATALITIES', 'INJURIES')], FUN=mean)
```

Top ten event types by fatalities and injuries are handled separately.
```{r cache=TRUE}
pickTopTen <- function(data, columnIndex) {
  head(data[order(-data[,c(columnIndex)]),], 10)
}
topFatalitiesSumByEventType <- pickTopTen(fatalitiesAndInjuriesSumByEventType, 2)
topInjuriesSumByEventType <- pickTopTen(fatalitiesAndInjuriesSumByEventType, 3)
topFatalitiesMeanByEventType <- pickTopTen(fatalitiesAndInjuriesMeanByEventType, 2)
topInjuriesMeanByEventType <- pickTopTen(fatalitiesAndInjuriesMeanByEventType, 3)
```

```{r}
```

While investigating storms' economical impact, the same aggregation is carried over property and crop damage expenditures after multiplying costs by respective exponent.

```{r cache=TRUE}
csv$PROPDMGEXP <- revalue(csv$PROPDMGEXP, c("K"=1000, "M"=1000000, "B"=1000000000), warn_missing = FALSE)
csv$CROPDMGEXP <- revalue(csv$CROPDMGEXP, c("K"=1000, "M"=1000000, "B"=1000000000), warn_missing = FALSE)
suppressWarnings(csv$PROPDMG <- csv$PROPDMG * as.integer(as.character(csv$PROPDMGEXP)))
suppressWarnings(csv$CROPDMG <- csv$CROPDMG * as.integer(as.character(csv$CROPDMGEXP)))
damagesSumByEventType <- aggregate(. ~ EVTYPE, data=csv[,c('EVTYPE', 'PROPDMG', 'CROPDMG')], FUN=sum)
damagesMeanByEventType <- aggregate(. ~ EVTYPE, data=csv[,c('EVTYPE', 'PROPDMG', 'CROPDMG')], FUN=mean)
```

Top ten event types by economical damages caused by storms are sorted by sum of property and crop damages.

```{r cache=TRUE}
damagesSumByEventType$SUM <- damagesSumByEventType$PROPDMG + damagesSumByEventType$CROPDMG
damagesMeanByEventType$MEAN <- damagesMeanByEventType$PROPDMG + damagesMeanByEventType$CROPDMG

topDamagesSumByEventType <- pickTopTen(damagesSumByEventType, 4)
topDamagesMeanByEventType <- pickTopTen(damagesMeanByEventType, 4)
```

## Results

### Personnel Damages

First total number of personnel damages is inspected by plotting top ten causes of deaths and injuries as sum by event type.

```{r}
fatalitiesSumPlot <- ggplot(topFatalitiesSumByEventType[,c('EVTYPE', 'FATALITIES')], aes(x=EVTYPE, y=FATALITIES)) + geom_bar(stat="identity") + coord_flip()
injuriesSumPlot <- ggplot(topInjuriesSumByEventType[,c('EVTYPE', 'INJURIES')], aes(x=EVTYPE, y=INJURIES)) + geom_bar(stat="identity")  + coord_flip()
layout <- matrix(seq(1, 2), ncol = 1, nrow = 2)
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
print(fatalitiesSumPlot, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
print(injuriesSumPlot, vp = viewport(layout.pos.row = 2, layout.pos.col = 1))
```

Then the personnel damages are inspected by plotting mean of top ten causes of deaths and injuries as mean by event type.

```{r}
fatalitiesMeanPlot <- ggplot(topFatalitiesMeanByEventType[,c('EVTYPE', 'FATALITIES')], aes(x=EVTYPE, y=FATALITIES)) + geom_bar(stat="identity") + coord_flip()
injuriesMeanPlot <- ggplot(topInjuriesMeanByEventType[,c('EVTYPE', 'INJURIES')], aes(x=EVTYPE, y=INJURIES)) + geom_bar(stat="identity")  + coord_flip()
layout <- matrix(seq(1, 2), ncol = 1, nrow = 2)
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
print(fatalitiesMeanPlot, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
print(injuriesMeanPlot, vp = viewport(layout.pos.row = 2, layout.pos.col = 1))
```

From the plots is very easy to see that tornadoes are main cause of fatalities and injuries. They have highest effect on health when viewed as sum and mean. However, also extreme heat causes high number of fatalities, about one third compared to tornadoes. 

When investigating mean values by event type, cold and snow becomes second to tornadoes by reaching slightly over half of their fatality level. Somewhat surprisingly heat wave is clearly most significant cause of injuries by singular event. Obviously tornadoes are more numerous than "cold and snow" or "heat wave" that cause injuries or fatalities.

### Damages

Damages are investigates by plotting sum and mean of combined property and crop damages by top ten event types.

```{r}
damagesSumPlot <- ggplot(topDamagesSumByEventType[,c('EVTYPE', 'SUM')], aes(x=EVTYPE, y=SUM)) + geom_bar(stat="identity") + coord_flip()
damagesMeanPlot <- ggplot(topDamagesMeanByEventType[,c('EVTYPE', 'MEAN')], aes(x=EVTYPE, y=MEAN)) + geom_bar(stat="identity") + coord_flip()
layout <- matrix(seq(1, 2), ncol = 1, nrow = 2)
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
print(damagesSumPlot, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
print(damagesMeanPlot, vp = viewport(layout.pos.row = 2, layout.pos.col = 1))
```

Floods clearly cause majority of damages, but on average tornadoes are more damaging to economy; floods accumulate damage by their numbers. The statistics could be analysed further by location of the events, for example do floods repeatedly concentrate on single areas and whether it would be feasible to prevent damages by building flood barries or safe overflow areas.